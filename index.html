<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Miaw Store — Plants vs Brainrot</title>
  <style>
    :root{--bg1:#050005;--bg2:#1a0033;--accent1:#8b00ff;--accent2:#de00ff}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#eaeaea;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 45%,#000 100%);-webkit-font-smoothing:antialiased}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,#ff6bd8,#7a00ff);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:26px;box-shadow:0 12px 40px rgba(122,0,255,0.18)}
    h1{margin:0;font-size:22px}
    .tag{opacity:.75;font-size:13px}
    main{display:grid;grid-template-columns:1fr 380px;gap:28px;padding:18px 28px}
    @media(max-width:980px){main{grid-template-columns:1fr} .sidebar{order:2}}
    .catalog{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border-radius:14px;padding:14px;display:flex;flex-direction:column;align-items:center;gap:10px;transition:transform .18s ease,box-shadow .18s ease;border:1px solid rgba(255,255,255,0.03)}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(122,0,255,0.12)}
    .plant-img{width:150px;height:150px;object-fit:contain;filter:drop-shadow(0 12px 30px rgba(0,0,0,0.6));transition:transform .25s}
    .plant-name{font-weight:700;margin:0}
    .price{font-weight:800;margin:4px 0}
    .muted{opacity:.75;font-size:13px;text-align:center}
    .btn{appearance:none;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;box-shadow:0 10px 30px rgba(139,0,255,0.14)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
    .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:14px;height:fit-content;position:sticky;top:18px}
    .cart-list{display:flex;flex-direction:column;gap:12px;max-height:420px;overflow:auto;padding-right:6px}
    .cart-item{display:flex;gap:10px;align-items:center}
    .ci-img{width:64px;height:64px;border-radius:10px;object-fit:contain}
    .ci-info{flex:1}
    .total{display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.03);margin-top:12px}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);visibility:hidden;opacity:0;transition:opacity .18s ease,visibility .18s ease;z-index:50;padding:20px}
    .modal.open{visibility:visible;opacity:1}
    .panel{width:920px;max-width:100%;background:#070007;border-radius:12px;padding:16px;box-shadow:0 40px 120px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
    footer{padding:24px 28px;text-align:center;opacity:.6;font-size:13px}
    .small{font-size:13px;opacity:.8}
    .anim-spin{animation:spin 1.4s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <h1>Miaw Store</h1>
        <div class="tag">Plants vs Brainrot — checkout verificado</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="small">Admin</div>
      <a class="btn btn-ghost" href="admin.html" target="_blank">Painel (separado)</a>
    </div>
  </header>

  <main>
    <section>
      <p class="small">Catálogo</p>
      <div class="catalog" id="catalog"></div>
    </section>

    <aside class="sidebar">
      <h3>Carrinho</h3>
      <div class="cart-list" id="cart-list"></div>

      <div class="total">
        <div>
          <div class="small">Total aproximado</div>
          <div style="font-weight:800;font-size:18px" id="cart-total">0 Robux</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn btn-primary" id="checkout">Finalizar compra</button>
        <button class="btn btn-ghost" id="clear-cart">Limpar</button>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(255,255,255,0.03)">
      <div class="small">Histórico local</div>
      <div id="history-list" style="margin-top:8px;max-height:160px;overflow:auto"></div>
    </aside>
  </main>

  <footer>
    Miaw Store • Projeto GitHub Pages
  </footer>

  <!-- Checkout modal (calls backend verify) -->
  <div class="modal" id="checkout-modal" aria-hidden="true">
    <div class="panel">
      <h3>Confirme sua compra</h3>
      <div id="checkout-items" style="max-height:200px;overflow:auto;margin-bottom:12px"></div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="buyer-username" placeholder="Seu username Roblox" style="flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:inherit">
        <input id="tx-id" placeholder="Transaction ID (opcional, mas recomendo)" style="flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:inherit">
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" id="cancel-checkout">Cancelar</button>
        <button class="btn btn-primary" id="verify-pay">Verificar e Confirmar</button>
      </div>

      <div id="checkout-message" style="margin-top:12px;color:#ffb6b6"></div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Troque API_BASE para o domínio onde você vai subir o backend (sem slash final)
    const API_BASE = 'https://seu-backend.example.com'; // trocar para seu deploy
    const BASE_RAW = 'https://raw.githubusercontent.com/Luiz-altf4/Miaw-Store/main/assets';

    const PRODUCTS = [
      {id:'tomatrio', name:'Tomatrio', price:50, img: BASE_RAW + '/tomatrio.png'},
      {id:'mango', name:'Mango', price:50, img: BASE_RAW + '/mango.png'},
      {id:'kinglimone', name:'King Limone', price:70, img: BASE_RAW + '/kinglimone.png'},
      {id:'shrombino', name:'Shrombino', price:50, img: BASE_RAW + '/shrombino.png'},
      {id:'starfruit', name:'Star Fruit', price:100, img: BASE_RAW + '/starfruit.png'},
      {id:'mrcarrot', name:'Mr Carrot', price:50, img: BASE_RAW + '/mrcarrot.png'}
    ];

    let cart = JSON.parse(localStorage.getItem('miaw_cart_v4')||'[]');
    let orders = JSON.parse(localStorage.getItem('miaw_orders_v4')||'[]');

    // render catalog
    function renderCatalog(){
      const el = document.getElementById('catalog');
      el.innerHTML = '';
      for(const p of PRODUCTS){
        const card = document.createElement('div'); card.className='card';
        const gpUrl = p.price ? `https://www.roblox.com/game-pass/${p.price===50? '1591926519' : (p.price===70? '1593857095' : (p.price===100? '1591582593':'1594232992'))}` : '#';
        card.innerHTML = `
          <img class="plant-img" src="${p.img}" onerror="this.src='https://via.placeholder.com/150?text=no+img'">
          <div style="text-align:center">
            <div class="plant-name">${p.name}</div>
            <div class="price">${p.price} Robux</div>
            <div class="muted">Clique em Pagar para abrir o gamepass</div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;width:100%">
            <button class="btn btn-primary" data-id="${p.id}" style="flex:1">Adicionar</button>
            <a class="btn btn-ghost" href="${gpUrl}" target="_blank" rel="noopener" style="padding:10px 12px;display:inline-flex;align-items:center">Pagar GAMEPASS</a>
          </div>
        `;
        el.appendChild(card);
      }
    }

    function saveCart(){ localStorage.setItem('miaw_cart_v4', JSON.stringify(cart)); renderCart(); }
    function cartTotal(){ return cart.reduce((s,i)=>s + i.price*i.qty, 0); }

    function addToCart(id){
      const prod = PRODUCTS.find(x=>x.id===id); if(!prod) return;
      const f = cart.find(x=>x.id===id);
      if(f) f.qty++; else cart.push({id:prod.id,name:prod.name,price:prod.price,img:prod.img,qty:1});
      saveCart();
    }
    function removeFromCart(id){ cart = cart.filter(x=>x.id!==id); saveCart(); }
    function changeQty(id,delta){ const it = cart.find(x=>x.id===id); if(!it) return; it.qty = Math.max(1,it.qty+delta); saveCart(); }
    function clearCart(){ cart=[]; saveCart(); }

    function renderCart(){
      const el = document.getElementById('cart-list'); el.innerHTML='';
      if(cart.length===0){ el.innerHTML='<div style="opacity:.7">Carrinho vazio</div>'; document.getElementById('cart-total').innerText='0 Robux'; return; }
      for(const it of cart){
        const row = document.createElement('div'); row.className='cart-item';
        row.innerHTML = `
          <img class="ci-img" src="${it.img}" onerror="this.src='https://via.placeholder.com/64'">
          <div class="ci-info">
            <div style="font-weight:800">${it.name}</div>
            <div style="opacity:.8">${it.price} Robux • ${it.qty} unidade(s)</div>
            <div style="margin-top:6px;display:flex;gap:8px">
              <button class="btn btn-ghost" data-dec="${it.id}">-</button>
              <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02)">${it.qty}</div>
              <button class="btn btn-ghost" data-inc="${it.id}">+</button>
              <button class="btn btn-ghost" data-rm="${it.id}">Remover</button>
            </div>
          </div>
        `;
        el.appendChild(row);
      }
      document.getElementById('cart-total').innerText = cartTotal() + ' Robux';
      renderHistory();
    }

    // checkout modal
    const checkoutModal = document.getElementById('checkout-modal');
    document.getElementById('checkout').addEventListener('click', ()=>{ if(cart.length===0) return alert('Carrinho vazio'); openCheckout(); });
    document.getElementById('cancel-checkout').addEventListener('click', ()=> closeModal(checkoutModal));

    function openCheckout(){
      const ci = document.getElementById('checkout-items'); ci.innerHTML='';
      for(const it of cart) ci.innerHTML += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)">${it.qty}x ${it.name} — ${it.price*it.qty} Rbx</div>`;
      openModal(checkoutModal);
    }
    function openModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }

    // verify with backend
    document.getElementById('verify-pay').addEventListener('click', async ()=>{
      const username = document.getElementById('buyer-username').value.trim();
      const tx = document.getElementById('tx-id').value.trim();
      if(!username) return alert('Coloque seu username Roblox');
      const total = cartTotal();
      if(total<=0) return alert('Carrinho vazio');

      // build payload
      const payload = { username, tx, total, items: cart.map(i=>({id:i.id,name:i.name,price:i.price,qty:i.qty})) };
      const url = API_BASE + '/api/verify';
      document.getElementById('checkout-message').innerText = 'Verificando...';
      try{
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await r.json();
        if(r.ok && json.ok){
          // save order locally to history too
          const my = JSON.parse(localStorage.getItem('miaw_my_history_v4')||'[]');
          my.unshift({ id: json.orderId, items: payload.items, total, username, tx, createdAt: new Date().toISOString(), status: 'pending' });
          localStorage.setItem('miaw_my_history_v4', JSON.stringify(my));
          cart = []; saveCart();
          closeModal(checkoutModal);
          alert('Pedido registrado — ID: ' + json.orderId);
        } else {
          let msg = json && json.error ? json.error : 'Erro na verificação';
          alert('Pedido não confirmado: ' + msg);
        }
      }catch(err){
        console.error(err);
        alert('Erro ao comunicar com o servidor — verifique sua conexão ou o deploy do backend.');
      } finally {
        document.getElementById('checkout-message').innerText = '';
      }
    });

    // history
    function renderHistory(){
      const el = document.getElementById('history-list'); el.innerHTML='';
      const arr = JSON.parse(localStorage.getItem('miaw_my_history_v4')||'[]');
      if(arr.length===0){ el.innerHTML='<div style="opacity:.7">Nenhum pedido local</div>'; return; }
      for(const o of arr.slice(0,8)){
        const d = document.createElement('div'); d.style.padding='8px 0';
        d.innerHTML = `<div style="font-weight:800">${o.id}</div><div style="opacity:.8">${o.items.map(i=>i.qty+'x '+i.name).join(', ')} • ${o.total} Robux</div>`;
        el.appendChild(d);
      }
    }

    // listeners (cart)
    document.addEventListener('click', (e)=>{
      const dec = e.target.getAttribute('data-dec');
      const inc = e.target.getAttribute('data-inc');
      const rm = e.target.getAttribute('data-rm');
      const aid = e.target.getAttribute('data-id');
      if(dec) changeQty(dec,-1);
      if(inc) changeQty(inc,1);
      if(rm) removeFromCart(rm);
      if(aid) addToCart(aid);
    });
    document.getElementById('clear-cart').addEventListener('click', ()=>{ if(!cart.length) return; if(confirm('Limpar carrinho?')) clearCart(); });

    // init
    renderCatalog();
    renderCart();
    renderHistory();
    window.MIAW = { cart, addToCart, clearCart };
  </script>
</body>
</html>
